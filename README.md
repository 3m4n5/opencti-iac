OpenCTI IaC (Hetzner Cloud + Ansible)

Overview
- Infrastructure-as-Code to provision an OpenCTI stack on Hetzner Cloud using Terraform and configure it using Ansible.
- Terraform provisions a server and static IPv4, and auto-generates an Ansible inventory.
- Ansible installs and configures OpenCTI (Docker Compose), NGINX reverse proxy, and TLS (Certbot), then starts the stack.

Repository layout
- terraform/
  - compute.tf: Hetzner server, primary IP, and inventory generation
  - variables.tf: Input variables (location, size, OS, etc.)
  - data.tf: References an existing Hetzner SSH key named "primary"
  - terraform.auto.tfvars: Local variable values (ignored by VCS by default)
- ansible/
  - playbooks/configure_opencti.yml: Main playbook to configure OpenCTI, NGINX, and TLS
  - group_vars/opencti.yml: Variables for admin credentials, domain, connector keys
  - deployed_files/: docker-compose.yml and NGINX template used by the playbook
  - inventory.ini: Auto-generated by Terraform with server IP and ansible_user

Prerequisites
- Hetzner Cloud
  - A Hetzner Cloud API token must already be created.
  - Upload your SSH public key to Hetzner Cloud and name it "primary" (or update data.tf).
- DNS
  - A domain you control and an A record pointing to the server public IPv4 (required for HTTPS via Certbot).
- Local tooling
  - Terraform 1.x+
  - Ansible 2.10+
  - Python 3.x and SSH client
  - Ansible collection community.docker (for the docker_compose module):
    - ansible-galaxy collection install community.docker

Configuration
- Terraform variables (terraform/terraform.auto.tfvars)
  - The Hetzner Cloud API key must be set here so Terraform can authenticate.
  - Example (do not commit secrets):
    - hcloud_token = "hetzner_api_token"
    - location     = "nbg1"
    - server_size  = "cpx41"
    - os_type      = "ubuntu-24.04"
    - server_name  = "prod-opencti-solo-nbg1"
    - ip_name      = "opencti_ip"
    - datacenter   = "nbg1-dc3"
- Ansible variables (ansible/group_vars/opencti.yml)
  - Update to your environment before running the playbook:
    - opencti_admin_email: Admin email for OpenCTI and Certbot
    - opencti_admin_password: Strong admin password for initial login
    - opencti_dns_name: FQDN you will point to the server
    - alienvault_api_key: Optional connector API key
    - nist_api_key: Optional connector API key
  - These values are used to generate /opt/opencti/.env on the target.

Important note on API keys
- The Hetzner Cloud API key should already be created and placed in terraform/terraform.auto.tfvars as hcloud_token.
- Do not commit terraform.auto.tfvars to version control.

Provisioning with Terraform
- From the repository root opencti-iac/opencti-iac:
  - terraform -chdir=terraform init
  - terraform -chdir=terraform plan -out=tfplan
  - terraform -chdir=terraform apply tfplan
- Outputs
  - terraform creates a server and primary IPv4 in the selected Hetzner location/datacenter.
  - terraform writes ansible/inventory.ini with the server IPv4 and ansible_user=root.

DNS
- Create/update an A record for your opencti_dns_name to point to the server IPv4 from the inventory.
- Certbot will fail if DNS is not in place or not propagated when the playbook runs.

Configure and deploy OpenCTI with Ansible
- Install the required Ansible collection locally (once):
  - ansible-galaxy collection install community.docker
- Run the playbook:
  - ansible-playbook -i ansible/inventory.ini ansible/playbooks/configure_opencti.yml
- What the playbook does:
  - Updates packages and installs prerequisites.
  - Creates an opencti user and directories under /opt/opencti.
  - Clones the OpenCTI docker repository and deploys docker-compose.yml.
  - Generates /opt/opencti/.env from group_vars.
  - Ensures Docker service is running, stops/starts the Compose stack.
  - Installs and configures NGINX, obtains a TLS certificate with Certbot for your domain, and enables the site.

Access
- After the playbook completes and TLS is issued, access your instance at:
  - https://<opencti_dns_name>
- Login using the admin email and password configured in ansible/group_vars/opencti.yml.

Day-2 operations
- Re-run only OpenCTI tasks:
  - ansible-playbook -i ansible/inventory.ini ansible/playbooks/configure_opencti.yml --tags opencti
- Re-run only NGINX/TLS tasks:
  - ansible-playbook -i ansible/inventory.ini ansible/playbooks/configure_opencti.yml --tags nginx

Teardown
- Destroy infrastructure and release resources in Hetzner:
  - terraform -chdir=terraform destroy

Assumptions and notes
- SSH key name
  - The Terraform data source in terraform/data.tf looks up an SSH key named "primary" in your Hetzner account. Rename your key accordingly or update data.tf to match your key name.
- Docker on the target host
  - The playbook installs docker-compose via apt and expects Docker to be available. If Docker is not present on the base image, ensure you install Docker Engine (e.g., docker.io) or update the playbook to install it.
- Certbot and DNS
  - The TLS step requires that the domain resolves to the server public IP and is reachable on ports 80/443 at the time of execution.
- Sensitive data
  - Do not commit terraform.auto.tfvars, API keys, or credentials. Rotate any credentials that were shared or committed inadvertently.

Troubleshooting
- SSH authentication failures
  - Ensure your local SSH key matches the one uploaded to Hetzner and your SSH agent is loaded.
- Certbot failures
  - Verify DNS A record for opencti_dns_name and allow time for propagation. Check that ports 80/443 are open (Hetzner defaults allow inbound unless you configured a firewall).
- Docker/Compose issues
  - Verify Docker service is installed and running: systemctl status docker on the target host.
  - Check container state: sudo -u opencti docker compose -f /opt/opencti/docker-compose.yml ps

License
- This repository does not include a license by default. Add one if needed for your distribution model.
